<!DOCTYPE html>
<html>
<head>
    <title>Folder and File Browser</title>
    <style>
        #browseResult td { border: 1px solid black }
        #searchResultsTbl td { border: 1px solid black }
        #tbl, #hdr, #searchResultsTbl { border-collapse: collapse; width: 100% }
        #closeDialog { position: absolute; top: 5px; right: 5px; border: none; background: transparent; font-size: 1.2em; cursor: pointer }
    </style>
    <link rel="icon" href="data:,">
</head>



<body>
    <button id="openBrowserBtn">Open File Browser</button>
    <dialog id="fileBrowserDialog">
        <button id="closeDialog">✖</button>
        <br/>
        <table id="hdr">
            <tr>
                <td style="width:10px">
                    <button id="btnUp" style="margin-right:5px;" title="Move up one directory">🔼</button>
                </td>
                <td>
                    <input id="pathBox" type="text" readonly style="width:100%;" />
                </td>
                <td style="width:50px">
                    <input id="searchBox" type="text" placeholder="Search" title="Search for files" />
                </td>
            </tr>
        </table>
        <button style="float:right" id="btnNewFolder" title="Add new folder">New 📁</button>
        <table id="tbl">
            <thead>
                <tr>
                    <th style="width:40px">Select</th>
                    <th>Name</th>
                    <th>Date Modified</th>
                    <th>Size</th>
                    <th>File Count</th>
                </tr>
            </thead>
            <tbody id="browseResult">
            </tbody>
        </table>
        <table style="width:100%">
            <tr>
                <td style="width:150px">
                    <button id="btnDelete" title="Delete files/folders">🗑️</button>
                    <button onclick="moveOrCopyItems('copy', prompt('Copy to path:'))" title="Copy files/folders">📑</button>
                    <button onclick="moveOrCopyItems('move', prompt('Move to path:'))" title="Move files/folders">🔀</button>
                    <button id="downloadBtn" title="Download files/folders">⬇️</button>
                </td>
                <td style="text-align:center" id="browseSummary"></td>
                <td style="text-align:right;width:1%">
                    <input type="file" id="uploadFiles" multiple style="display:none;" />
                    <button id="btnUpload" title="Upload files">Upload⬆️</button>
                </td>
            </tr>
        </table>
        <table id="searchResultsTbl" style="margin-top:20px; display:none;">
            <thead>
                <tr>
                    <th>File Search Result</th>
                    <th>Size</th>
                </tr>
            </thead>
            <tbody id="searchResultsBody">
            </tbody>
        </table>
    </dialog>
        <script>
            //helper functions
            $ = id => document.getElementById(id), $el = (el, attrs = {}) => (e => (Object.entries(attrs).forEach(([k, v]) => k.startsWith('data-') ? e.setAttribute(k, v) : e[k] = v), e))(document.createElement(el));
            $$ = sel => document.querySelectorAll(sel);
            HTMLElement.prototype.on = function (e, fn) { this.addEventListener(e, fn) };
            HTMLElement.prototype.appendChildren = function (...n) { return n.forEach(x => this.appendChild(x)), this };

            const baseUrl = '/test/browse';

            //save history for forward/back
            const updateUrl = (path, search) => {
                const params = new URLSearchParams();
                if (path) params.set('path', path);
                if (search) params.set('search', search);
                const newUrl = `${window.location.pathname}?${params.toString()}`;
                window.history.pushState({ path, search }, '', newUrl);
            };

            //show files/folders in browseResult tbody
            const browseFolder = (path = "") => {
                const url = path ? `${baseUrl}?path=${encodeURIComponent(path)}` : baseUrl;
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        const browseResult = $('browseResult');
                        browseResult.innerHTML = "";
                        $('pathBox').value = path || "/";
                        const btnUp = $('btnUp');
                        btnUp.disabled = !path;
                        btnUp.onclick = () => {
                            if (!path) return;
                            const parentPath = path.includes("/") ? path.substring(0, path.lastIndexOf("/")) : "";
                            browseFolder(parentPath);
                        };

                        //iterate folders, build tr
                        data.folders.forEach(folder => {
                            const row = $el('tr');
                            const selectCell = $el('td');
                            const checkbox = $el('input', { type: 'checkbox', value: folder.name, 'data-type': 'folder' });
                            selectCell.appendChild(checkbox);
                            const tdName = $el('td', { textContent: '📁' + folder.name, style: 'cursor: pointer' });
                            tdName.dataset.type = 'folder';
                            row.appendChildren(
                                selectCell,
                                tdName,
                                $el('td', { textContent: folder.dateModified }),
                                $el('td'),
                                $el('td', { textContent: folder.fileCount })
                            );
                            browseResult.appendChild(row);
                        });

                        //iterate files, build tr
                        data.files.forEach(file => {
                            const row = $el('tr');
                            const selectCell = $el('td');
                            const checkbox = $el('input', { type: 'checkbox', value: file.name, 'data-type': 'file' });
                            selectCell.appendChild(checkbox);
                            const fileCell = $el('td', { textContent: '📄' + file.name, style: 'cursor: pointer' });
                            fileCell.dataset.type = 'file';
                            row.appendChildren(
                                selectCell,
                                fileCell,
                                $el('td', { textContent: file.dateModified }),
                                $el('td', { textContent: file.size }),
                                $el('td')
                            );
                            browseResult.appendChild(row);
                        });
                        //show summary
                        $('browseSummary').textContent = `Folder count: ${data.folders.length}, File count: ${data.files.length}`;
                        updateUrl(path, $('searchBox').value);
                    });
            };

            //add debounced click/dblclick event handlers for TD elements that have dataset.type set
            const browseResult = $('browseResult');
            browseResult.on('click', e => {
                const td = e.target.closest('td');
                if (!td || !td.dataset.type || td.querySelector('input')) return;
                const tr = td.parentElement;
                const type = td.dataset.type;
                const name = td.textContent.slice(2).trim();
                const path = $('pathBox').value === '/' ? '' : $('pathBox').value;
                clearTimeout(td.clickTimer);
                td.clickTimer = setTimeout(() => {
                    if (type === 'folder') browseFolder(path ? `${path}/${name}` : name);
                    else window.open(`/${path ? `${path}/` : ''}${name}`, '_blank');
                }, 300);
            });
            browseResult.on('dblclick', e => {
                const td = e.target.closest('td');
                if (!td || !td.dataset.type) return;
                clearTimeout(td.clickTimer);
                const type = td.dataset.type; 
                const name = td.textContent.slice(2).trim();
                const path = $('pathBox').value === '/' ? '' : $('pathBox').value;
                startRename(td, name, type, path);
            });

            //show files from search in separate table
            const searchFiles = query => {
                if (!query) {
                    $('searchResultsTbl').style.display = 'none';
                    updateUrl($('pathBox').value === '/' ? '' : $('pathBox').value, '');
                    return;
                }
                fetch(`/test/search?query=${encodeURIComponent(query)}`)
                    .then(r => r.json())
                    .then(files => {
                        const tbody = $('searchResultsBody');
                        tbody.innerHTML = "";
                        files.forEach(f => {
                            const row = $el('tr');
                            row.appendChildren(
                                $el('td', { textContent: f.Path }),
                                $el('td', { textContent: f.Size })
                            );
                            tbody.appendChild(row);
                        });
                        $('searchResultsTbl').style.display = files.length ? 'table' : 'none';
                        updateUrl($('pathBox').value === '/' ? '' : $('pathBox').value, query);
                    });
            };
            $('searchBox').on('keypress', e => {
                if (e.key === 'Enter') searchFiles(e.target.value);
            });

            //upload files from file input to path in pathBox input
            const uploadFilesInput = $('uploadFiles'), btnUpload = $('btnUpload');
            btnUpload.on('click', () => uploadFilesInput.click());
            uploadFilesInput.on('change', () => {
                const files = Array.from(uploadFilesInput.files);
                if (!files.length) return;
                const formData = new FormData();
                files.forEach(f => formData.append('files', f));
                let currentPath = $('pathBox').value;
                if (currentPath === '/') currentPath = '';
                formData.append('path', currentPath);
                fetch('/test/upload', {
                    method: 'POST',
                    body: formData
                })
                    .then(r => r.json())
                    .then(result => {
                        browseFolder(currentPath);
                    })
                    .catch(err => {
                        console.error(err);
                        alert('Upload failed');
                    })
                    .finally(() => uploadFilesInput.value = '');
            });

            //pass checked checkboxes to delete endpoint for deletion if confirmed
            $('btnDelete').on('click', () => {
                const checkboxes = $$('#browseResult input[type="checkbox"]:checked');
                if (!checkboxes.length) return alert('No files or folders selected');
                if (!confirm(`Delete ${checkboxes.length} item(s)?`)) return;
                const items = Array.from(checkboxes).map(cb => ({
                    name: cb.value,
                    type: cb.getAttribute('data-type')
                }));
                const currentPath = $('pathBox').value === '/' ? '' : $('pathBox').value;
                fetch('/test/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path: currentPath, items })
                })
                    .then(r => r.json())
                    .then(result => {
                        browseFolder(currentPath);
                    })
                    .catch(err => {
                        console.error(err);
                        alert('Delete failed');
                    });
            });

            //enable adding folder to current path in pathBox
            $('btnNewFolder').on('click', () => {
                let folderName = prompt("Enter new folder name:");
                if (!folderName) return;
                let currentPath = $('pathBox').value === '/' ? '' : $('pathBox').value;
                fetch('/test/newfolder', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path: currentPath, folderName })
                })
                    .then(r => r.json())
                    .then(result => {
                        browseFolder(currentPath);
                    })
                    .catch(err => {
                        console.error(err);
                        alert('Failed to create folder');
                    });
            });

            //enable move/copy from source in pathBox to destination in prompt
            const moveOrCopyItems = (action, destinationPath) => {
                const checkboxes = $$('#browseResult input[type="checkbox"]:checked');
                if (!checkboxes.length) return alert('No items selected');

                const items = Array.from(checkboxes).map(cb => ({
                    name: cb.value,
                    type: cb.getAttribute('data-type')
                }));

                const sourcePath = $('pathBox').value === '/' ? '' : $('pathBox').value;

                fetch(`/test/${action}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sourcePath, 
                        destinationPath,
                        items
                    })
                })
                    .then(r => r.json())
                    .then(() => browseFolder(sourcePath));
            }

            //called on dblclick to allow renaming of files/folders
            //replaces td content with an input box and restores it
            const startRename = (td, oldName, type, currentPath) => {
                td.querySelector('input')?.remove();
                td.textContent = '';
                const input = $el('input', { type: 'text', value: oldName, style: 'width:90%' });
                td.appendChild(input);
                input.focus();
                input.select();

                const finish = newName => td.textContent = (type === 'folder' ? '📁' : '📄') + newName;

                const renameOnServer = newName => {
                    const path = currentPath === '/' ? '' : currentPath;
                    fetch('/test/rename', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ path, oldName, newName, type })
                    })
                        .then(r => r.json())
                        .then(res => res.error ? (alert(res.error), finish(oldName)) : finish(newName))
                        .catch(err => (console.error(err), finish(oldName)));
                };

                input.on('blur', () => finish(oldName));
                input.on('keydown', e => {
                    if (e.key === 'Enter') {
                        const newName = input.value.trim();
                        if (!newName) return finish(oldName);
                        renameOnServer(newName);
                    } else if (e.key === 'Escape') {
                        finish(oldName);
                        e.stopPropagation();
                        e.preventDefault();
                    }
                });
            }

            //download selected items as zip
            $('downloadBtn').on('click', () => {
                const path = $('pathBox').value === '/' ? '' : $('pathBox').value;
                const checkboxes = $$('#browseResult input[type="checkbox"]:checked');
                if (!checkboxes.length) return alert('No items selected');

                const items = Array.from(checkboxes).map(cb => ({
                    name: cb.value,
                    type: cb.getAttribute('data-type')
                }));

                fetch('/test/download', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ items, path })
                })
                    .then(response => {
                        if (!response.ok) throw new Error('Failed to create zip');
                        return response.blob();
                    })
                    .then(blob => {
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'download.zip';
                        a.click();
                        URL.revokeObjectURL(url);
                    })
                    .catch(err => alert(err.message));
            });

            //restore state for back/forward 
            window.onpopstate = e => {
                const params = new URLSearchParams(window.location.search);
                const path = params.get('path') || '';
                const search = params.get('search') || '';

                $('searchBox').value = search;
                if (search) searchFiles(search);
                else {
                    $('searchResultsTbl').style.display = 'none';
                    browseFolder(path);
                }
            };
            const params = new URLSearchParams(window.location.search);
            const initialPath = params.get('path') || '';
            const initialSearch = params.get('search') || '';
            if (initialSearch) {
                $('searchBox').value = initialSearch;
                searchFiles(initialSearch);
            } else browseFolder(initialPath);

            //event handlers for dialog
            $('openBrowserBtn').on('click', () => $('fileBrowserDialog').showModal());
            $('closeDialog').on('click', () => $('fileBrowserDialog').close())
        </script>

</body>
</html>